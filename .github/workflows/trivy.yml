name: Trivy IaC Scan

on:
  push:
    branches: ["main", "prod"]
  pull_request:
    branches: ["main", "prod"]

permissions:
  contents: read
  security-events: write # For uploading to Security Tab
  pull-requests: write   # For commenting on PRs

jobs:
  trivy_scan:
    name: Trivy IaC Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # 1. Create .trivyignore (Dynamic Exclusions)
      # ------------------------------------------------------------------------
      - name: Create .trivyignore
        run: |
          cat <<EOF > .trivyignore
          # AWS S3: Server Access Logging (Often handled centrally)
          AVD-AWS-0089
          # AWS S3: Encryption (If relying on AWS managed keys)
          AVD-AWS-0132
          # AWS CloudWatch: Log Group Encryption
          AVD-AWS-0017
          # AWS Security Group: Missing Description
          AVD-AWS-0124
          EOF

      # ------------------------------------------------------------------------
      # 2. Run Trivy (Config Mode for IaC)
      # ------------------------------------------------------------------------
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          hide-progress: false
          format: "sarif"
          output: "trivy-results.sarif"
          exit-code: "1"            # Fail build on issues
          ignore-unfixed: true
          severity: "HIGH,CRITICAL" # Only major issues
          trivyignores: .trivyignore

      # ------------------------------------------------------------------------
      # 3. Upload Results to GitHub Security Tab
      #    (This creates the "Annotations" inside the Files Changed tab)
      # ------------------------------------------------------------------------
      - name: Upload SARIF to Security Tab
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-results.sarif"

      # ------------------------------------------------------------------------
      # 4. Post Single Summary Comment
      # ------------------------------------------------------------------------
      - name: Post/Update PR Comment
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Unique Marker to identify OUR comment (prevents duplicates)
            const MARKER = '';

            try {
              const sarif = JSON.parse(fs.readFileSync('trivy-results.sarif', 'utf8'));
              const run = sarif.runs && sarif.runs[0];
              const results = run && run.results ? run.results : [];
              const failedCount = results.length;
              
              // Determine Status
              const emoji = failedCount > 0 ? '❌' : '✅';
              const summaryText = failedCount > 0 
                ? `⚠️ **Trivy found ${failedCount} High/Critical Issues**` 
                : `✅ **Trivy Scan Passed**`;

              // Generate Table Rows (Limit to first 20 to avoid giant comments)
              const rows = results.slice(0, 20).map(r => {
                const ruleId = r.ruleId;
                const level = r.level;
                // Try to get clean file path and line
                const location = r.locations && r.locations[0] && r.locations[0].physicalLocation;
                const file = location ? location.artifactLocation.uri : 'Unknown';
                const line = location ? location.region.startLine : '?';
                const msg = r.message.replace(/\n/g, ' '); // remove newlines for table
                
                return `| ${level} | \`${file}:${line}\` | ${ruleId} | ${msg} |`;
              }).join('\n');

              // Build Comment Body
              let commentBody = `${MARKER}\n### ${emoji} Trivy IaC Scan Results\n\n${summaryText}\n\n`;
              
              if (failedCount > 0) {
                commentBody += `<details><summary><b>Click to view detailed findings</b></summary>\n\n`;
                commentBody += `| Severity | Location | Rule | Message |\n| :--- | :--- | :--- | :--- |\n${rows}\n`;
                
                if (failedCount > 20) {
                  commentBody += `\n...and ${failedCount - 20} more issues (see Files tab).`;
                }
                commentBody += `\n</details>`;
              } else {
                commentBody += `No High or Critical infrastructure misconfigurations found.`;
              }

              // GitHub API Interaction
              const { owner, repo } = context.repo;
              const { data: comments } = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: context.issue.number,
              });

              // Find previous comment by Marker
              const botComment = comments.find(c => c.body.includes(MARKER));

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
              }
            } catch (error) {
              console.log('Error in script:', error);
            }