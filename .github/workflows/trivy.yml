name: Trivy IaC Scan

on:
  push:
    branches: ["main", "prod"]
  pull_request:
    branches: ["main", "prod"]

permissions:
  contents: read
  security-events: write # Required for uploading to Security Tab
  pull-requests: write   # Required for posting comments on PRs

jobs:
  trivy_scan:
    name: Trivy IaC Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # MUST HAVE: Ignore specific noisy rules here.
      # We create a .trivyignore file dynamically.
      # You can find Rule IDs at: https://avd.aquasec.com/
      # ------------------------------------------------------------------------
      - name: Create .trivyignore
        run: |
          cat <<EOF > .trivyignore
          # Ignore: S3 Bucket Logging Enabled (Often handled by a central audit bucket)
          AVD-AWS-0089
          # Ignore: S3 Bucket Encryption (If you trust AWS default encryption)
          AVD-AWS-0132
          # Ignore: Ensure that CloudWatch Log Group is encrypted by KMS
          AVD-AWS-0017
          # Ignore: Security Group Rules should include a description
          AVD-AWS-0124
          EOF

      # ------------------------------------------------------------------------
      # MUST HAVE: 'config' scan type for Terraform
      # ------------------------------------------------------------------------
      - name: Run Trivy Vulnerability Scanner (SARIF)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: "config"
          hide-progress: false
          format: "sarif"
          output: "trivy-results.sarif"
          exit-code: "1"            # Fail the build if issues are found
          severity: "HIGH,CRITICAL" # Only fail on major issues
          trivyignores: .trivyignore # Use the file we created above

      # ------------------------------------------------------------------------
      # Generate JSON output for detailed PR comments with remediation guidance
      # ------------------------------------------------------------------------
      - name: Run Trivy Vulnerability Scanner (JSON)
        if: always() # Run even if SARIF scan failed
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: "config"
          hide-progress: false
          format: "json"
          output: "trivy-results.json"
          exit-code: "0"            # Don't fail - we already failed above if needed
          severity: "HIGH,CRITICAL"
          trivyignores: .trivyignore

      # ------------------------------------------------------------------------
      # Upload results to GitHub Security Tab (Code Scanning)
      # ------------------------------------------------------------------------
      - name: Upload SARIF to Security Tab
        if: success() || failure() # Run even if Trivy found issues
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-results.sarif"

      # ------------------------------------------------------------------------
      # Post a friendly comment to the PR
      # ------------------------------------------------------------------------
      - name: Post PR Comment
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            try {
              // Read the JSON file for detailed information
              const trivyJson = JSON.parse(fs.readFileSync('trivy-results.json', 'utf8'));

              // Extract all misconfigurations from all results
              let allIssues = [];
              if (trivyJson.Results) {
                trivyJson.Results.forEach(result => {
                  if (result.Misconfigurations) {
                    result.Misconfigurations.forEach(issue => {
                      allIssues.push({
                        ...issue,
                        Target: result.Target // Add file path info
                      });
                    });
                  }
                });
              }

              const failedCount = allIssues.length;

              // Define Status
              const emoji = failedCount > 0 ? 'âŒ' : 'âœ…';
              const title = failedCount > 0
                ? `âš ï¸ Trivy found ${failedCount} High/Critical Issue${failedCount > 1 ? 's' : ''}`
                : `âœ… Trivy Security Scan Passed`;

              const { owner, repo } = context.repo;
              const { GITHUB_SERVER_URL, GITHUB_REPOSITORY } = process.env;
              // Link to the "Files Changed" tab where annotations appear
              const checksUrl = `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/pull/${context.issue.number}/files`;

              // Build detailed table with file paths and remediation
              let detailsTable = '';
              if (failedCount > 0) {
                detailsTable = `| File | Rule ID | Severity | Issue | Remediation |
              | :--- | :--- | :--- | :--- | :--- |
              ${allIssues.slice(0, 15).map(issue => {
                const file = issue.Target || 'N/A';
                const ruleId = issue.AVDID || issue.ID || 'N/A';
                const severity = issue.Severity || 'UNKNOWN';
                const title = (issue.Title || 'No description').replace(/\|/g, '\\|');
                const remediation = (issue.Resolution || 'See documentation').replace(/\|/g, '\\|').substring(0, 100);
                const avdUrl = ruleId.startsWith('AVD') ? `https://avd.aquasec.com/misconfig/${ruleId.toLowerCase()}` : '#';
                return `| \`${file}\` | [${ruleId}](${avdUrl}) | **${severity}** | ${title} | ${remediation}${remediation.length >= 100 ? '...' : ''} |`;
              }).join('\n')}
              ${failedCount > 15 ? `\n_... and ${failedCount - 15} more issue${failedCount - 15 > 1 ? 's' : ''}._` : ''}`;
              }

              // Build the comment body
              const commentBody = `### ${emoji} Trivy IaC Scan Results

              **Status**: ${title}

              ${failedCount > 0 ? `<details>
              <summary>ðŸ“‹ Show ${failedCount} Issue${failedCount > 1 ? 's' : ''} (with remediation guidance)</summary>

              ${detailsTable}

              </details>

              ðŸ’¡ **Tip**: Click on Rule IDs for detailed documentation and examples.

              [View full annotations in Files tab](${checksUrl})` : 'ðŸŽ‰ No security issues found in your infrastructure code!'}`;

              // Find existing bot comment to update (avoid spamming)
              const { data: comments } = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('Trivy IaC Scan Results')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
              }
            } catch (error) {
              console.log('Error processing JSON or posting comment:', error);
              console.log('Error details:', error.message);
            }