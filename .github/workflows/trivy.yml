name: Trivy IaC Scan

on:
    push:
        branches:
            - main
            - prod
    pull_request:
        branches:
            - main
            - prod

permissions:
    contents: read
    security-events: write
    pull-requests: write

jobs:
    trivy_scan:
        name: Trivy IaC Scan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Run Trivy Vulnerability Scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "config"
                  hide-progress: false
                  format: "sarif"
                  output: "trivy-results.sarif"
                  exit-code: "1"
                  ignore-unfixed: true
                  severity: "HIGH,CRITICAL"

            - name: Filter SARIF Results (High/Critical Only)
              if: success() || failure()
              run: |
                  sudo apt-get install jq
                  # Filter results to only keep those with level 'error' (High/Critical)
                  if [ -f trivy-results.sarif ]; then
                    jq 'del(.runs[].results[] | select(.level != "error"))' trivy-results.sarif > trivy-filtered.sarif
                  else
                    echo "trivy-results.sarif not found"
                    exit 1
                  fi

            - name: Upload SARIF to Security Tab
              if: success() || failure()
              uses: github/codeql-action/upload-sarif@v4
              with:
                  sarif_file: "trivy-filtered.sarif"

            - name: Post PR Comment
              if: github.event_name == 'pull_request' && (success() || failure())
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const fs = require('fs');

                      try {
                        const sarif = JSON.parse(fs.readFileSync('trivy-filtered.sarif', 'utf8'));
                        const run = sarif.runs[0];
                        const results = run.results || [];
                        const failed = results.length;
                        
                        const emoji = failed > 0 ? '❌' : '✅';
                        const statusMessage = failed > 0 
                          ? `⚠️ **Trivy found ${failed} HIGH/CRITICAL issue(s)**` 
                          : `✅ **Trivy passed:** No critical issues found.`;

                        const { owner, repo } = context.repo;
                        const { GITHUB_SERVER_URL, GITHUB_REPOSITORY } = process.env;
                        const checksUrl = `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/pull/${context.issue.number}/checks`;

                        const commentBody = `❌ Trivy IaC Scan Results
                        ${statusMessage}
                        
                        [View detailed results](${checksUrl})`;

                        const { data: comments } = await github.rest.issues.listComments({
                          owner,
                          repo,
                          issue_number: context.issue.number,
                        });

                        const botComment = comments.find(comment => 
                          comment.user.type === 'Bot' && 
                          comment.body.includes('Trivy IaC Scan Results')
                        );

                        if (botComment) {
                          await github.rest.issues.updateComment({
                            owner,
                            repo,
                            comment_id: botComment.id,
                            body: commentBody
                          });
                        } else {
                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: context.issue.number,
                            body: commentBody
                          });
                        }
                      } catch (error) {
                        console.log('Error processing SARIF or posting comment:', error);
                      }
